<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChromAI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap');

        .xl {
            font-family: 'Poppins', sans-serif;
            font-size: calc(3vw + 2vh);
            font-weight: 800;
        }

        .l {
            font-family: 'Poppins', sans-serif;
            font-size: calc(2vw + 2vh);
            font-weight: 800;
        }

        .m {
            font-family: 'Poppins', sans-serif;
            font-size: calc(1.2vw + 1vh);
            font-weight: 800;
        }

        .mm {
            font-family: 'Poppins', sans-serif;
            font-size: calc(1vw + 1vh);
            font-weight: 700;
        }

        .s {
            font-family: 'Poppins', sans-serif;
            font-size: calc(0.5vw + 1vh);
            font-weight: 700;
        }

        /* Remove annoying margin in paragraphs */
        .p-no-margin-top {
            margin-block-start: 0;
            margin-inline-start: 0;
        }

        .p-no-margin-bottom {
            margin-block-end: 0;
            margin-inline-end: 0;
        }

        html, body {
            padding: 0;
            margin: 0 auto;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, rgba(122, 92, 36, 1) 0%, rgba(57, 15, 85, 1) 100%);
            height: 100vh;
        }

        .container {
            height: 100vh;
            display: flex;
            margin: 0 auto;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
        }

        .tooltip-ai-effect {
            background: linear-gradient(17deg, rgba(255, 65, 65, 1) 0%, rgba(218, 200, 27, 1) 10%, rgba(133, 235, 29, 1) 23%, rgba(37, 217, 197, 1) 35%, rgba(29, 159, 255, 1) 46%, rgba(189, 61, 235, 1) 57%, rgba(255, 57, 124, 1) 67%, rgba(255, 65, 65, 1) 78%, rgba(218, 200, 27, 1) 89%, rgba(133, 235, 29, 1) 100%);
            background-size: 500% 500%;
            animation: rainbow 20s ease-in-out infinite;
            background-clip: text;
            -webkit-background-clip: text;
            color: rgba(255, 255, 255, 255)
        }

        @keyframes rainbow {
            0% {
                background-position: left
            }
            50% {
                background-position: right
            }
            100% {
                background-position: left
            }
        }

        .content {
            min-height: 40vh;
            text-align: center;
            border-radius: 30px;
            padding: 50px;
            background-color: #171424;
            display: block;
            width: 30%;
            font-weight: 500;
        }

        .image {
            width: 100%;
            height: 250px;
            background-image: url("banner.png");
            background-size: cover;
            background-position: center;
            border-radius: 20px;
        }

        .subtitle {
            color: lightgray;
        }

        #camera-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        video {
            width: 100%;
            max-width: 30vw;
            border-radius: 20px;
        }

        canvas {
            margin-top: 10px;
            width: 100%;
            max-width: 30vw;
            border-radius: 10px;
        }

        .button-container {
            background-color: #1c182d;
            border-radius: 20px;
            padding: 10px;
            margin-top: 30px;
            display: flex;
            justify-content: space-evenly;
        }

        #results-screen {
            color: lightgray;
            background-color: #25213b;
            border-radius: 20px;
            padding: 10px;
            margin-top: 30px;
            display: none;
            text-align: center;
        }

        #colour {
            background: slategray;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            margin-right: 7px;
        }

        .result-image {
            margin: 20px;
            width: 300px;
            height: auto;
            background: #8c8c8c;
            border-radius: 12px;
        }

        .results-container {
            margin-top: 15px;
            text-align: center;
            align-content: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .login-button {
            margin: 20px;
            padding: 20px 50px;
            font-family: 'Poppins', sans-serif;
            border-radius: 10px;
            font-weight: 600;
            font-size: 18px;
            background-color: #4b3fb0;
            color: white;
            border: none;
            cursor: pointer;
        }

        .butfil {
            display: none;
            width: calc(100% - 40px);
        }

        .result-flex {
            display: flex
        }

        .colour-label {
            margin-bottom: 20px;
        }

        @media only screen and (max-width: 1500px) {
            .content {
                width: 35%;
            }

            .notice {
                width: calc(35% - 20px) !important;
            }
        }

        @media only screen and (max-width: 1300px) {
            .content {
                width: 40%;
            }

            .results-container .login-button {
                display: none;
            }

            .butfil {
                display: block;
            }

            .result-image {
                min-height: 200px
            }

            .notice {
                width: calc(40% - 20px) !important;
                top: 90px;
            }
        }

        @media only screen and (max-width: 1150px) {
            .content {
                width: 45%;
            }

            .l {
                font-size: calc(3vw + 2vh);
            }

            .s {
                font-size: calc(1vw + 1vh);
            }

            .notice {
                width: calc(45% - 20px) !important;
            }
        }

        @media only screen and (max-width: 1000px) {
            .content {
                width: 500px;
            }

            .s {
                font-size: calc(1.2vw + 1vh);
            }

            .notice {
                width: 480px !important;
            }
        }


        @media only screen and (max-width: 700px) {
            .content {
                min-height: 100vh;
                width: 90vw;
                padding: 100px;
            }

            .notice {
                width: calc(90vw - 20px) !important;
                top: 40px !important;
            }

            .p-no-margin-top {
                margin-block-end: 1em;
                margin-inline-end: 0;
            }

            .p-no-margin-bottom {
                margin-block-end: 1em;
                margin-inline-end: 0;
            }

            .button-container {
                flex-direction: column;
            }

            .login-button {
                margin: 15px;
            }

            .l {
                font-size: calc(4vw + 2vh);
            }

            .s {
                font-size: calc(1.7vw + 1.2vh);
            }

            .mm {
                font-size: calc(2vw + 1.5vh);
            }

            .colour-label {
                margin-bottom: 10px;
            }

            .result-image {
                width: auto;
            }

            .result-flex {
                flex-direction: column;
            }
        }

        .hero {
            width: 100%;
            text-align: center;
            padding: 30px 0;
            user-select: none;
        }

        .hero .logo {
            max-width: 80px;
            width: 10vw;
            display: block;
            margin: auto;
        }

        .notice {
            position: absolute;
            top: 80px;
            text-align: center;
            width: calc(30% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .error {
            color: #541417;
            background: #ffb3b3;
        }

        .success {
            background: #a0ff7e;
            color: #157e00;
        }

        .dashboard-modal {
            padding: 30px;
            border-radius: 10px;
            border: none;
            color: lightgray;
            background-color: #171424;
        }
    </style>
</head>
<body>
<div class="container">
    <dialog id="uploading-dialog" class="dashboard-modal">
        <span class="m">Subiendo...</span>
    </dialog>
    <div class="content">
        <div id="notice" class="notice s" style="display: none"></div>
        <div class="hero">
            <img src="logo.png" draggable="false" alt="Logo de ChromAI" class="logo"/>
            <h3 class="l tooltip-ai-effect p-no-margin-bottom p-no-margin-top">Chrom<span
                    style="color: rgba(0, 0, 0, 0)">AI</span></h3>
        </div>
        <div id="start-page-container">
            <div id="start-page-content">
                <div class="image"></div>
                <h4 class="s subtitle">Identificá colores a base de imágenes usando inteligencia artificial</h4>
            </div>
            <div id="div-with-buttons" class="button-container">
                <label for="file-upload" class="login-button">Subir imagen</label>
                <input id="file-upload" type="file" style="display: none;"/>
                <button class="login-button" id="open-camera">Sacar una foto</button>
            </div>
            <div id="camera-container">
                <video id="video" autoplay></video>
                <canvas id="canvas"></canvas>
                <div class="button-container" style="width: 100%">
                    <button class="login-button" id="capture-button">Capturar foto</button>
                    <div id="once-picture-taken" style="display: none">
                        <button class="login-button" id="upload-picture-button">Utilizar esta foto</button>
                        <button class="login-button" id="open-camera2">Sacar otra foto</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="results-screen">
            <div class="result-flex">
                <img id="result-image" class="result-image"/>
                <div class="results-container">
                    <span class="colour-label s">Se detectó que el color principal es</span>
                    <div style="display: flex; align-items: center; align-self: center">
                        <div id="colour"></div>
                        <span id="colour-id" class="mm">slategray</span>
                    </div>
                    <button class="login-button" id="go-back-button">Analizar otra imagen</button>
                </div>
            </div>
            <button class="login-button butfil" id="go-back-button2">Analizar otra imagen</button>
        </div>
    </div>
</div>

<script>

    /**
     * ChromAI
     * Analizar colores de imágenes a base de inteligencia artificial.
     * Front desarrollado por Gerardo Wacker, back por Martín Curzel
     *
     * ¡¡¡¡¡¡¡¡¡¡¡¡¡¡¡ADVERTENCIA!!!!!!!!!!!!!!!
     * EL CÓDIGO QUE VAS A LEER ES MUY MALO Y NO DEBE SER TOMADO COMO
     * REFERENCIA EN TÉRMINO AL ESTILO QUE LLEVAN LOS DESARROLLADORES
     *
     */

    // Un poco de definición de elementos. JavaScript vanilla es un poco tedioso para manejar.
    // O sea, fijate la cantidad de constantes que tengo que definir para que ésto funcione normalmente.
    // Aguante React loko.
    const openCameraButton = document.getElementById('open-camera');
    const openCameraButton2 = document.getElementById('open-camera2');
    const captureButton = document.getElementById('capture-button');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraContainer = document.getElementById('camera-container');
    const startPageContent = document.getElementById('start-page-content')
    const divWithButtons = document.getElementById('div-with-buttons')
    const context = canvas.getContext('2d');
    const content = document.getElementById('start-page-container');
    const resultsScreen = document.getElementById('results-screen');
    const fileUploadLabel = document.getElementById('file-upload')
    const uploadingDialog = document.getElementById('uploading-dialog')
    const resultImage = document.getElementById('result-image')
    const colourId = document.getElementById('colour-id')
    const colour = document.getElementById('colour')
    const oncePictureTaken = document.getElementById('once-picture-taken')
    const uploadPhotoButton = document.getElementById('upload-picture-button')
    const goBackButton = document.getElementById('go-back-button')
    const goBackButton2 = document.getElementById('go-back-button2')

    // Lector de archivos. Se usa para visualizar la imagen cuando se carga.
    const reader = new FileReader()

    // A ver si vamos abriendo la cámara...
    let isCameraOpen = false;

    // Oh Caperucita, es para observarte mejor...
    function openCamera()
    {
        // Mostrar el contenedor de la imagen directamente, y ocultar el resto que no necesita.
        cameraContainer.style.display = 'flex';
        canvas.style.display = 'none'
        startPageContent.style.display = 'none';
        divWithButtons.style.display = 'none';
        video.style.display = 'block';
        captureButton.style.display = 'inherit'
        oncePictureTaken.style.display = 'none'

        // Sólo encender el stream de la cámara si es que ésta no se encuentra ejecutándose.
        if (!isCameraOpen)
        {
            navigator.mediaDevices.getUserMedia({video: true})
                .then(function (stream)
                {
                    video.srcObject = stream; // Stream the video feed to the video element
                    isCameraOpen = true;
                })
                .catch(function (err)
                {
                    console.log('Error accessing the camera: ' + err);
                });
        }
    }

    // Agarrá los datos que vienen del feed de la cámara, capturalos, y envialos al video.
    captureButton.addEventListener('click', function ()
    {
        // Che, ¿pero no habíamos abierto la cámara? Bueno. Ésto es por las dudelis.
        if (!isCameraOpen)
        {
            openCamera();
        }
        else
        {
            // Haceme el canvas para que tenga el tamaño del video.
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Y dibujámelo.
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Cuando terminamos de capturar la foto, parame el stream del video así no consumimos recursos.
            const stream = video.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(function (track)
            {
                track.stop()
            });

            // Cuando ya 'ta, ocultame el video y mostrame el canvas.
            canvas.style.display = 'block';
            video.style.display = 'none';

            // Para terminar, cerrame la cámara.
            isCameraOpen = false;

            captureButton.style.display = 'none'
            oncePictureTaken.style.display = 'inherit'
        }
    });

    // Un poco de eventos.
    // Abrime la cámara cuando cliqueás en "Sacar foto".
    openCameraButton.addEventListener('click', openCamera)
    openCameraButton2.addEventListener('click', openCamera)

    // Volver pa'trás.
    goBackButton.addEventListener('click', goBack)
    goBackButton2.addEventListener('click', goBack)

    // Cuando seleccionás una imagen, subila.
    fileUploadLabel.addEventListener('change', (event) => checkImage(event))

    function checkImage(event)
    {
        // Chequeá que sea sólo de estos formatos, y menor a 5 mb (me saturás el servidor si no).
        const allowedFiles = ['jpg', 'jpeg', 'png', 'webp']
        if (event.target.files && event.target.files[0])
        {
            if (!allowedFiles.includes(event.target.files[0].name.split('.').pop()))
                return displayUserMessage({
                    type: 'error',
                    message: '¡El formato seleccionado de la imagen es incorrecto! Sólo se permiten JPG, PNG o WebP.'
                })
            if (event.target.files[0].size / 1024 / 1024 > 5)
                return displayUserMessage({type: 'error', message: '¡El archivo seleccionado es muy grande!'})
            // Mostrar el diálogo de "Subiendo...".
            uploadingDialog.showModal()
            // Subir el archivo.
            upload(event.target.files[0]).then(result =>
            {
                console.log(result)
                // Si salió bien...
                if (result.success)
                {
                    // Guardame el archivo de la foto para mostrarlo.
                    photo = event.target.files[0];
                    reader.readAsDataURL(photo);
                    // Seteame los resultados.
                    loadResults(result.content)
                    // Cerrame el diálogo de "Subiendo...".
                    uploadingDialog.close()
                }
                else
                    displayUserMessage({type: 'error', message: result.content})
            })
        }
    }

    // Cargar imagen dentro del placeholder.
    reader.onload = event =>
    {
        resultImage.src = event.target.result;
    }

    // Subir foto.
    uploadPhotoButton.addEventListener('click', uploadCanvasContent)

    // Obtener el contenido del canvas y subirlo.
    function uploadCanvasContent()
    {
        // Obtener el contenido del canvas como una URL en formato base64.
        const dataURL = canvas.toDataURL('image/png');

        // Convertirlo a un Blob amorfo.
        fetch(dataURL)
            .then(res => res.blob())
            .then(blob =>
            {
                // Creame un archivo a partir del blob.
                const file = new File([blob], 'canvas-image.png', {type: 'image/png'});
                console.log(file)

                // Subime la foto.
                // Mostrar el diálogo de "Subiendo...".
                uploadingDialog.showModal()
                // Subir el archivo.
                upload(file).then(result =>
                {
                    console.log(result)
                    // Si salió bien...
                    if (result.success)
                    {
                        // Guardame el archivo de la foto para mostrarlo.
                        photo = file;
                        reader.readAsDataURL(photo);
                        // Seteame los resultados.
                        loadResults(result.content)

                        // Cerrame el diálogo de "Subiendo...".
                        uploadingDialog.close()
                    }
                    else
                        displayUserMessage({type: 'error', message: result.content})
                })
            })
            .catch(err => displayUserMessage({type: 'error', message: 'Error al crear el archivo:' + err}));
    }

    // Mostrar mensajitos.
    function displayUserMessage(notification)
    {
        const notice = document.getElementById('notice')

        notice.className = 'notice s ' + notification.type
        notice.innerHTML = notification.message

        notice.style.display = 'block'
        setTimeout(() => notice.style.display = 'none', 5000)

        console.log('[PASÓ ALGO]')
        console.log(notification)
    }

    // Función para subir imágenes en multipart. Un placer.
    function upload(file)
    {
        // Se pretende hacer un Promise para garantizar el comportamiento asincrónico.
        return new Promise(res =>
        {
            // Crear un objeto de formulario para poder enviarlo por multipart.
            const data = new FormData()
            // Agregarle la imagen correspondiente como `file`.
            data.append('file', file)

            // Realizar la petición hacia el endpoint correspondiente.
            fetch('https://3e82-181-167-70-207.ngrok-free.app/detect', {
                method: 'POST',
                body: data
            }).then(r =>
            {
                // Si no está pipi cucú, mostrar dónde quedamos.
                if (r.status !== 200)
                    return r.text().then(response => res({success: false, status: r.status, content: response}))
                r.text().then(response =>
                {
                    // Ahh, pero si 'ta bien, mandale nomás.
                    return res({success: true, content: response})
                })
            })
        })
    }

    // Cargar los resultados.
    function loadResults(response)
    {
        let res = JSON.parse(response)
        if(res.objects.length === 0)
            return displayUserMessage({type: 'error', message: 'No se detectaron objetos en la imagen'})

        let colourName = res.objects[0].dominant_color;

        colourId.innerHTML = colourName;
        colour.style.background = colourName;

        // Mostrame los resultados.
        showResults()
    }

    // Volver al principio.
    function goBack()
    {
        // No la compliquemos mucho.
        location.reload()
    }

    // Cuando esté, mostrame los resultados.
    function showResults()
    {
        content.style.display = 'none'
        resultsScreen.style.display = 'block'
    }
</script>
</body>
</html>
